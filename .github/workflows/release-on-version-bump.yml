name: Auto Bump Version, Build Plugin Zip and Release

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  bump-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      # ------------------------------------------------------------------
      # 1Ô∏è‚É£ Get latest valid tag (vX.Y.Z)
      # ------------------------------------------------------------------
      - name: Get current tag
        id: get_tag
        run: |
          latest_tag=$(git tag -l "v[0-9]*" --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then latest_tag="v1.0.0"; fi
          echo "latest_tag=${latest_tag}" >> $GITHUB_ENV
          echo "Detected latest tag: ${latest_tag}"

      # ------------------------------------------------------------------
      # 2Ô∏è‚É£ Calculate next patch version
      # ------------------------------------------------------------------
      - name: Calculate next version
        id: next_version
        run: |
          version=${latest_tag#v}
          IFS='.' read -r major minor patch <<< "$version"
          patch=$((patch + 1))
          new_version="${major}.${minor}.${patch}"
          echo "new_version=${new_version}" >> $GITHUB_ENV
          echo "Next version: $new_version"

           # ------------------------------------------------------------------
      # 3Ô∏è‚É£ Update plugin header version (super-robust)
      # ------------------------------------------------------------------
      - name: Update plugin header version
        run: |
          file="meals-db-main.php"
          echo "üîß Updating version in $file to $new_version"
          dos2unix "$file" || true

          # Match optional spaces or asterisks before "Version:"
          sed -i -E "s/^[[:space:]]*(\*[[:space:]]*)?Version:[[:space:]]*[0-9.]+/ * Version: ${new_version}/I" "$file"

          echo "‚úÖ Resulting version line:"
          grep -i "Version:" "$file" | head -n 1 || echo "‚ö†Ô∏è No Version line found"

          git add "$file"
          git diff --cached || true
          git commit -m "chore: bump plugin version to ${new_version}" || echo "No changes to commit"

      # ------------------------------------------------------------------
      # 4Ô∏è‚É£ Create and push tag
      # ------------------------------------------------------------------
      - name: Create Git tag
        id: tag
        run: |
          git tag -a "v${new_version}" -m "Release v${new_version}"
          git push origin "v${new_version}"
          git push

      # ------------------------------------------------------------------
      # 5Ô∏è‚É£ Build plugin zip with correct root folder
      # ------------------------------------------------------------------
      - name: Build plugin zip
        id: build
        run: |
          mkdir build
          mkdir build/meals-db-main
          rsync -av --exclude='.git' --exclude='build' --exclude='.github' ./ build/meals-db-main/
          cd build
          zip -r meals-db-main.zip meals-db-main
          cd ..

      # ------------------------------------------------------------------
      # 6Ô∏è‚É£ Create GitHub Release and attach zip
      # ------------------------------------------------------------------
      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.new_version }}
          name: "Release v${{ env.new_version }}"
          body: "Automated release for version v${{ env.new_version }}."
          files: build/meals-db-main.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------
      # 7Ô∏è‚É£ Rollback safeguard ‚Äî runs if any previous step fails
      # ------------------------------------------------------------------
      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Build or release failed. Rolling back tag and release..."
          git push --delete origin "v${new_version}" || true
          git tag -d "v${new_version}" || true

          # Delete the draft release from GitHub (if it was created)
          release_id=$(gh api repos/${{ github.repository }}/releases/tags/v${new_version} --jq '.id' || true)
          if [ -n "$release_id" ]; then
            gh api repos/${{ github.repository }}/releases/$release_id -X DELETE || true
            echo "üßπ Deleted incomplete GitHub release ID $release_id"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
